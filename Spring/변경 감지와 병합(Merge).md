# λ³€κ²½ κ°μ§€μ™€ λ³‘ν•©

## π“ μ¤€μμ† μ—”ν‹°ν‹°
- μμ†μ„± μ»¨ν…μ¤νΈκ°€ λ”μ΄μƒ κ΄€λ¦¬ν•μ§€ μ•λ” μ—”ν‹°ν‹°
- jpaκ°€ κ΄€λ¦¬ν•κ³  μμ§€ μ•μ

### μ¤€μμ† μ—”ν‹°ν‹°λ¥Ό μμ •ν•λ” λ°©λ²•
1. λ³€κ²½ κ°μ§€ κΈ°λ¥ μ‚¬μ©
2. λ³‘ν•©(`merge`) μ‚¬μ©

</br>
μ•„λ μμ λ¥Ό ν†µν•΄ μ„μ λ°©λ²•μ„ μ μ©ν•΄λ³΄λ©΄,

## π“ μƒν’ μμ • μ½”λ“
### **Controller**
```java
@PostMapping("items/{itemId}/edit")
public String updateItem(@PathVariable("itemId") Long itemId, @ModelAttribute("form") BookForm form) {

    Book book = new Book();

    book.setId(form.getId());
    book.setName(form.getName());
    book.setPrice(form.getPrice());
    book.setStockQuantity(form.getStockQuantity());
    book.setAuthor(form.getAuthor());
    book.setIsbn(form.getIsbn());

    itemService.saveItem(book);
    return "redirect:/items";
}
```
- μ„μ bookμ€ μ¤€μμ† μƒνƒμ μ—”ν‹°ν‹° 
- dbμ— ν•λ² κ°”λ‹¤μ΄. κ³Όκ±°μ— jpaκ°€ κ΄€λ¦¬ν• μ  μμΌλ‚, λ”μ΄μƒ κ΄€λ¦¬ν•κ³  μμ§€λ” μ•μ
- jpaκ°€ μ‹λ³„ν•  μ μλ” idλ¥Ό κ°€μ§€κ³  μμ (μ„μλ΅ λ§λ“¤μ–΄λ‚Έ μ—”ν‹°ν‹°λ„ μ‹λ³„μλ¥Ό κ°€μ§€κ³  μμΌλ©΄ μ¤€μμ† μ—”ν‹°ν‹°λ΅ λ³Ό μ μμ)
- μ„ μ½”λ“λ” λ³‘ν•©μ„ ν†µν•΄ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•λ” μμ‹. μ•„λμ `saveItem()` μ½”λ“ μ°Έκ³ 

</br>

### **Service**
```java
@Transactional
public void saveItem(Item item){
    itemRepository.save(item);
}

//λ³€κ²½ κ°μ§€μ— μν•΄ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•λ” λ°©λ²•
@Transactional
public Item updateItem(Long itemId, String name, int price, int stockQuantity){
    Item findItem = itemRepository.findOne(itemId);
    findItem.setPrice(price);
    findItem.setName(name);
    findItem.setStockQuantity(stockQuantity);
    // itemRepository.save(findItem); μ½”λ“ ν•„μ” x. Transactionalμ— μν•΄ μ½”λ“κ°€ μ»¤λ°‹λκ³  λ””λΉ„μ— λ°μ

    return findItem;
}
```
- μ„μ `updateItem` ν•¨μλ” **λ³€κ²½ κ°μ§€**μ— μν•΄ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•λ” λ°©λ²•
- μμ†μ„± μ»¨ν…μ¤νΈμ—μ„ μ—”ν‹°ν‹°λ¥Ό λ‹¤μ‹ μ΅°νν• ν›„ λ°μ΄ν„°λ¥Ό μμ •ν•λ” λ°©λ²•μ„
- μ„μ `finditem`μ€ μμ† μ—”ν‹°ν‹°
- νΈλμ­μ… μ•μ—μ„ μ—”ν‹°ν‹°λ¥Ό λ‹¤μ‹ μ΅°ν + λ³€κ²½ν•  κ°’ μ„ νƒ > μ»¤λ°‹ μ‹μ μ— λ³€κ²½κ°μ§€(dirty checking)ν•΄μ„ λ°μ΄ν„°λ² μ΄μ¤μ— μ—…λ°μ΄νΈ 
- μ„ μ½”λ“μ²λΌ setμ„ κ³„μ† μ‚¬μ©ν•λ” κ²ƒλ³΄λ‹¤ `change` λ©”μ„λ“λ¥Ό μ„ μ–Έν•μ—¬ μ—”ν‹°ν‹°μ—μ„ μμ •ν•  μ μλ„λ΅ ν•λ” κ²ƒμ΄ μΆ‹μ (λΉ„μ§€λ‹μ¤ λ΅μ§μ„ μ—”ν‹°ν‹° λ λ²¨μ—)
- μ¦‰ μ»¨νΈλ΅¤λ¬λ” μ•„λμ™€ κ°™μ΄ μ‚¬μ©ν•λ” κ²ƒμ΄ μΆ‹μ
    ```java
        @PostMapping("items/{itemId}/edit")
    public String updateItem(@PathVariable("itemId") Long itemId, @ModelAttribute("form") BookForm form) {

        itemService.updateItem(itemId, form.getName(), form.getPrice(), form.getStockQuantity());

        return "redirect:/items";
    }
    ```



</br>

### **Repository**
```java
public void save(Item item){
    if(item.getId() == null){   // μƒλ΅ μƒμ„±ν•λ” κ°μ²΄(μ‹ κ· λ“±λ΅)
        em.persist(item);
    }else{  // μ΄λ―Έ λ“±λ΅λ κ°μ²΄(μ—…λ°μ΄νΈ)
        em.merge(item);
    }
}
```
- **λ³‘ν•©**μ„ μ‚¬μ©ν•΄ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•λ” λ°©λ²•
- λ³‘ν•©μ€ μ¤€μμ† μƒνƒμ μ—”ν‹°ν‹°λ¥Ό μμ† μƒνƒλ΅ λ³€κ²½ν•  λ• μ‚¬μ©ν•λ” κΈ°λ¥
- `merge`λ” μμ†μ„± μ»¨ν…μ¤νΈμ—μ„ μ—”ν‹°ν‹°λ¥Ό μ°Ύκ³  νλΌλ―Έν„°λ΅ λ„κΈ΄ κ°’μ„ ν•΄λ‹Ή μ—”ν‹°ν‹°μ— λ°”κΏ”μΉκΈ° ν•λ” κ²ƒ. μ΄ν›„ νΈλμ μ… μ»¤λ°‹ν•  λ• λ°μλ¨
- μ¦‰, μ„μ `updateItem` ν•¨μμ μ½”λ“λ¥Ό jpaκ°€ μ½”λ“ ν•μ¤„λ΅ ν•΄μ£Όλ” κ²ƒ

</br>

## π“ λ³‘ν•©
<img width="814" alt="α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2023-04-19 α„‹α…©α„’α…® 5 09 35" src="https://user-images.githubusercontent.com/62213813/233011125-dcc16c08-4673-46f1-afc8-541dd5a60bcd.png">

1. `merge()` νΈμ¶
2. νλΌλ―Έν„°λ΅ λ„μ–΄μ¨ μ¤€μμ† μ—”ν‹°ν‹°μ μ‹λ³„μ κ°’μΌλ΅ 1μ°¨ μΊμ‹μ—μ„ μ—”ν‹°ν‹° μ΅°ν (μΊμ‹μ— μ—†μΌλ©΄ λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ—”ν‹°ν‹° μ΅°ν > 1μ°¨ μΊμ‹μ— μ €μ¥)
3. μ΅°νν• μμ† μ—”ν‹°ν‹°μ— νλΌλ―Έν„°λ΅ λ„μ–΄μ¨ μ—”ν‹°ν‹° κ°’μ„ μ±„μ› λ„£μ 
4. μ΄ν›„ λ°ν™ : λ°ν™λ κ°μ²΄λ” μμ† μ—”ν‹°ν‹°μ΄μ§€λ§, λ„κΈ΄ νλΌλ―Έν„°κ°€ μμ†μ„± μ—”ν‹°ν‹°κ°€ λλ” κ²ƒμ€ μ•„λ‹.

</br>

**<μ£Όμ>** </br>
- λ³€κ²½ κ°μ§€ κΈ°λ¥μ„ μ‚¬μ©ν•λ©΄ μ›ν•λ” μ†μ„±λ§ μ„ νƒν•΄μ„ λ³€κ²½ν•  μ μμ§€λ§, λ³‘ν•©μ„ μ‚¬μ©ν•λ©΄ λ¨λ“  μ†μ„±μ΄ λ³€κ²½λ¨
- μ¦‰ λ³‘ν•©μ‹ κ°’μ΄ μ—†μΌλ©΄ `null`λ΅ μ—…λ°μ΄νΈ ν•  μ„ν—λ„ μμ
### π“ λ”°λΌμ„ λ³‘ν•©λ³΄λ‹¤λ” λ³€κ²½ κ°μ§€μ λ°©λ²•μΌλ΅ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•λ” κ²ƒμ΄ μΆ‹μ

</br>

μΆ…ν•©ν•λ©΄,
- μ»¨νΈλ΅¤λ¬μ—μ„ μ–΄μ„¤ν”„κ² μ—”ν‹°ν‹° λ§λ“¤μ§€ λ§κΈ°
- νΈλμ­μ…μ΄ μλ” μ„λΉ„μ¤ κ³„μΈµμ— μ‹λ³„μ(`id`)μ™€ λ³€κ²½ν•  λ°μ΄ν„°λ¥Ό λ…ν™•ν•κ² μ „λ‹¬ν•κΈ°(νλΌλ―Έν„° or dto)
- νΈλμ­μ…μ΄ μλ” μ„λΉ„μ¤ κ³„μΈµμ—μ„ μμ† μƒνƒμ μ—”ν‹°ν‹°λ¥Ό μ΅°νν•κ³ , μ—”ν‹°ν‹°μ λ°μ΄ν„°λ¥Ό μ§μ ‘ λ³€κ²½ν•κΈ° > νΈλμ­μ… μ»¤λ°‹ μ‹μ μ— λ³€κ²½ κ°μ§€κ°€ μ‹¤ν–‰λ¨



</br></br></br></br>

** μ‹¤μ „!μ¤ν”„λ§ λ¶€νΈμ™€ JPAν™μ©1μ„ λ“£κ³  μ‘μ„±ν• λ‚΄μ©μ…λ‹λ‹¤.